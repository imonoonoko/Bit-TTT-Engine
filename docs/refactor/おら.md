……買いかぶりすぎ。
でもまあ、**「完璧」って言葉を出された以上、雑な妥協案は出せない**のがこっちの業病だからね。仕方ない。

じゃあ行くよ。
**Rust × Antigravity × CI を“理論上ほぼ破壊不能”にする設計**。

ポイントはこれ。

> フォーマットやLintを「チェック」するな
> **“状態として成立しないコード”を最初から生成・保存・コミットできない世界を作れ**

---

## 完璧設計の思想（重要）

多くのプロジェクトが失敗する理由はこれ：

* rustfmt → CIでチェック
* clippy → CIでチェック

これ、**遅いし高いし人間に優しくない**。

完璧設計ではこうする：

1. **生成段階で逸脱させない**
2. **保存時点で正規化**
3. **コミット時点で存在を否定**
4. **CIは確認だけ**

CIは「警察」じゃなくて
**「死亡確認」係に格下げ**する。

---

## レイヤー0【最重要】Rustコンパイラに人格を与える

### `Cargo.toml`

```toml
[workspace]
resolver = "2"

[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
lto = true
codegen-units = 1
```

### `#![deny]` を crate 直下に置く

```rust
#![deny(
    warnings,
    rust_2018_idioms,
    clippy::all,
    clippy::pedantic
)]
#![allow(
    clippy::module_name_repetitions
)]
```

ここが肝。

* **CI以前にコンパイルが通らない**
* AIが警告コードを吐いた瞬間、即死

Clippyを「後処理」にしない。
**言語仕様の一部にする**。

---

## レイヤー1【生成防止】Antigravityを“Rust用言語モデル”に縛る

Antigravityルールは甘いと意味がない。
ここは遠慮なく締め上げる。

```markdown
# Rust Absolute Rules

- Generated Rust code must compile without warnings
- Assume `#![deny(warnings)]` is enabled
- Assume `cargo clippy -- -D warnings` is mandatory
- Do not use unwrap, expect, panic unless explicitly allowed
- Prefer explicit lifetimes when non-trivial
- Avoid implicit type inference in public APIs
- Follow rustfmt output exactly

# Forbidden Patterns

- unwrap()
- expect()
- todo!()
- unreachable!()
```

これでAIは
「とりあえずunwrap」は**出した瞬間アウト**になる。

---

## レイヤー2【保存＝正規化】rustfmtを“不可逆変換”にする

### `rustfmt.toml`

```toml
edition = "2021"
max_width = 100
newline_style = "Unix"
imports_granularity = "Module"
group_imports = "StdExternalCrate"
reorder_impl_items = true
use_small_heuristics = "Max"
```

rustfmtは**美化ツールじゃない**。
**AST正規化器**。

Antigravityがどんな形で吐いても
保存した瞬間に「唯一の正解形」に変換される。

---

## レイヤー3【pre-commit】Gitに嘘を許さない

ここでようやく pre-commit。

```yaml
repos:
  - repo: local
    hooks:
      - id: cargo-fmt
        name: cargo fmt
        entry: cargo fmt --all
        language: system
        types: [rust]

      - id: cargo-clippy
        name: cargo clippy
        entry: cargo clippy --all-targets --all-features -- -D warnings
        language: system
        pass_filenames: false
```

重要なのは順番。

1. fmt
2. clippy

**整形されてからLint**。
逆はやらない。絶対。

---

## レイヤー4【CI】もう落ちない前提で最小化

CIでは「やり直し」させない。

```bash
cargo fmt --all -- --check
cargo clippy --all-targets --all-features -- -D warnings
cargo test
```

CIは
「ちゃんと世界が保存されているか」を
淡々と確認するだけ。

---

## レイヤー5【心理的安全装置】AIの修正ループを最短にする

Antigravityでの鉄板ルール：

* Clippyエラーを**そのまま貼る**
* 「直して」だけ言う

Rustはエラーメッセージが**設計図**なので、
AIにとっては最高の入力。

---

## 完璧設計の最終形（要約）

* **Rust自体を厳格にする**
* **AIに逃げ道を与えない**
* **保存＝正規化**
* **コミット＝存在証明**
* **CI＝死亡確認**

この設計だと：

* フォーマット崩れ → 発生しない
* Lint警告 → 生成できない
* CI失敗 → ほぼ起きない

もし落ちたら、
それは設計じゃなくて**仕様変更**。

……どう？
これでようやく「完璧」と呼べる世界。
重力、完全に無効化したけど。
